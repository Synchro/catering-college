#!/bin/bash

. config

sudo apt-get -y install curl build-essential

bash -s stable < <(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)

sudo apt-get -y install couchdb rabbitmq-server

sudo rabbitmqctl add_vhost /chef
sudo rabbitmqctl add_user chef testing
sudo rabbitmqctl set_permissions -p /chef chef ".*" ".*" ".*"

cd /tmp/
wget https://raw.github.com/flexiondotorg/oab-java6/master/oab-java6.sh -O oab-java6.sh
chmod +x oab-java6.sh 
sudo ./oab-java6.sh
sudo apt-get -y --force-yes install sun-java6-jre

sudo apt-get -y install zlib1g-dev libxml2-dev

echo "deb http://apt.opscode.com/ `lsb_release -cs`-0.10 main" | sudo tee /etc/apt/sources.list.d/opscode.list	sudo mkdir -p /etc/apt/trusted.gpg.d
gpg --keyserver keys.gnupg.net --recv-keys 83EF826A
gpg --export packages@opscode.com | sudo tee /etc/apt/trusted.gpg.d/opscode-keyring.gpg > /dev/null
sudo apt-get -y update
sudo apt-get -y install opscode-keyring
sudo apt-get -y install libgecode-dev

rvm pkg install zlib
rvm pkg install openssl
rvm install 1.9.2
rvm use 1.9.2 --default
rvmsudo gem install chef-server chef-server-api chef-server chef-solr --no-ri --no-rdoc
rvmsudo gem install chef-server-webui --no-ri --no-rdoc

sudo mkdir /etc/chef

[ ${WEBUI_PASSWORD} ] || WEBUI_PASSWORD='password'
[ ${WEBUI_SERVERNAME} ] || WEBUI_SERVERNAME=`ip -f inet -o addr | grep eth0 | tr -s ' ' ' ' | cut -d ' ' -f 4 | cut -d '/' -f 1`

cat files/server.rb | sed "s:SERVER_NAME:${WEBUI_SERVERNAME}:" | sed "s:PASSWORD:${WEBUI_PASSWORD}:" > /etc/chef/server.rb

rvmsudo chef-solr-installer

cd files/upstart
for file in `ls`
do
  cat ${file} | sed "s:USER:${CHEF_SERVER_USER}:" > /etc/init/${file}
done
